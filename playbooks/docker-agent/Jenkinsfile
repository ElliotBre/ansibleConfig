pipeline {
    agent { label 'ansible-agent-1'}
    environment {
        PUBKEY = credentials('agentPubKey')
    }
        stages {
            stage ("Setup") {
                steps {
                    checkout scmGit(
                        branches: [[name: 'main']],
                        userRemoteConfigs: [[url: 'git@github.com:ElliotBre/ansibleConfig.git']])
                        // sh "touch hosts.yaml"
                        // withCredentials([file(credentialsId: 'ansible-hosts', variable: 'HOSTS')]){
                        //     sh "cp \$HOSTS hosts.yaml"
                        // }
                }
             }
             stage ("Dry Run") {
                steps {
                  sh "pwd"
                  sh "ls -a"
                  sh "ansible-playbook playbooks/docker-agent/docker-agent-setup.yaml --extra-vars \"ssh_public_key='\${SSH_KEY}'\" --check"
                }
             }
             stage ("Run") {
                steps {
                  sh "ansible-playbook playbooks/docker-agent/docker-agent-setup.yaml --extra-vars \"ssh_public_key='\${SSH_KEY}'\""
                }
             }
        }
}
